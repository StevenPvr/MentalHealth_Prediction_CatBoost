"""Pipeline principal de prÃ©paration des donnÃ©es."""

import sys
from pathlib import Path

# Support exÃ©cution directe: ajouter la racine du projet au sys.path
project_root = Path(__file__).parent.parent.parent
if str(project_root) not in sys.path:
    sys.path.insert(0, str(project_root))

from src.logging_setup import get_logger
from src.utils import RANDOM_STATE
from src.data_preparation.data_preparation import (
    load_cleaned_dataset,
    split_train_val_test,
    save_splits
)


def prepare_data() -> None:
    """
    ExÃ©cute le pipeline complet de prÃ©paration des donnÃ©es.
    
    Steps:
        1. Charge le dataset nettoyÃ©
        2. Split en train (60%), val (20%), test (20%)
        3. Sauvegarde en Parquet
    """
    logger = get_logger(__name__)

    logger.info("ğŸ”„ Chargement du dataset nettoyÃ©...")
    df = load_cleaned_dataset()
    logger.info("   âœ“ %d lignes, %d colonnes", len(df), len(df.columns))

    logger.info("ğŸ”„ Split train/val/test (60/20/20)...")
    train, val, test = split_train_val_test(df, random_state=RANDOM_STATE)
    logger.info("   âœ“ Train: %d lignes (%.1f%%)", len(train), len(train) / len(df) * 100)
    logger.info("   âœ“ Val: %d lignes (%.1f%%)", len(val), len(val) / len(df) * 100)
    logger.info("   âœ“ Test: %d lignes (%.1f%%)", len(test), len(test) / len(df) * 100)

    logger.info("ğŸ’¾ Sauvegarde des splits (1 fichier avec colonne 'split')...")
    logger.debug("   â†’ Conversion en type catÃ©goriel...")
    save_splits(train, val, test)
    logger.info("   âœ“ splits.parquet (toutes colonnes = category)")
    logger.info("   âœ“ splits.csv")

    logger.info("âœ… PrÃ©paration terminÃ©e avec succÃ¨s!")


if __name__ == "__main__":
    prepare_data()


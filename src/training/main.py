"""Pipeline principal d'entraÃ®nement du modÃ¨le."""

import sys
from pathlib import Path
from typing import cast
import pandas as pd

# Ajouter la racine du projet au sys.path pour les imports
project_root = Path(__file__).parent.parent.parent
if str(project_root) not in sys.path:
    sys.path.insert(0, str(project_root))

from src.logging_setup import get_logger
from src.training.training import (
    load_splits,
    filter_train_val,
    separate_features_target,
    train_model,
    save_model
)


def train_pipeline() -> None:
    """
    ExÃ©cute le pipeline complet d'entraÃ®nement.
    
    Steps:
        1. Charge splits.parquet
        2. Filtre train et val
        3. SÃ©pare features et target
        4. EntraÃ®ne le modÃ¨le avec early stopping
        5. Sauvegarde le modÃ¨le
    """
    logger = get_logger(__name__)

    logger.info("ğŸ”„ Chargement des donnÃ©es...")
    df = load_splits()
    logger.info("   âœ“ %d lignes chargÃ©es", len(df))

    logger.info("ğŸ”„ Filtrage train/val...")
    df_train_val = filter_train_val(df)
    logger.info("   âœ“ %d lignes (train + val)", len(df_train_val))

    logger.info("ğŸ”„ SÃ©paration train et val...")
    train_df = cast(pd.DataFrame, df_train_val[df_train_val['split'] == 'train'].drop(columns=['split']))
    val_df = cast(pd.DataFrame, df_train_val[df_train_val['split'] == 'val'].drop(columns=['split']))
    logger.info("   âœ“ Train: %d lignes", len(train_df))
    logger.info("   âœ“ Val: %d lignes", len(val_df))

    logger.info("ğŸ”„ SÃ©paration features/target...")
    X_train, y_train = separate_features_target(train_df)
    X_val, y_val = separate_features_target(val_df)
    logger.info("   âœ“ Features: %d colonnes", len(X_train.columns))

    logger.info("ğŸš€ EntraÃ®nement du modÃ¨le CatBoost...")
    logger.info("   Logs: learn = TRAIN | test = VALIDATION")
    separator = "=" * 60
    logger.info(separator)
    model = train_model(X_train, y_train, X_val, y_val, early_stopping_rounds=50)
    logger.info(separator)
    logger.info("   âœ“ ModÃ¨le entraÃ®nÃ© : %d arbres", model.tree_count_)

    logger.info("ğŸ’¾ Sauvegarde du modÃ¨le...")
    save_model(model)
    logger.info("   âœ“ model_saved/catboost_model.cbm")

    logger.info("âœ… EntraÃ®nement terminÃ© avec succÃ¨s!")


if __name__ == "__main__":
    train_pipeline()

